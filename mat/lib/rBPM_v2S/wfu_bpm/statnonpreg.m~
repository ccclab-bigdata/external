function [ beta, stats ] = statnonpreg( x,y,C,B,PiCond )

%-Parameters & Initialisation
%=======================================================================
%-Work out degrees of freedom
%-----------------------------------------------------------------------
q       = size([C B],1);		%-# observations
p       = size([C B],2);		%-# predictors
r       = rank([C B]);		%-Model degrees of freedom
df      = q - r;			%-Residual degrees of freedom
nPerm   = size(PiCond,1);		%-# permutations

%=======================================================================
% - C O R R E C T   P E R M U T A T I O N
%=======================================================================
% Work out correct permuation completely. Separating the first
% permutation simplifies the permutation loop (fewer conditionals) and
% allows determination of pseudo-t threshold when saving supratheshold
% statistics.

perm = 1;

	%-Estimate parameters and sum of squares due to error.
	% Use pseudo inverse rather than BETA=inv(D'*D)*D'*X for 
	% D = DesMtx, to allow for non-unique designs. See matlab help.
	%-----------------------------------------------------------------
	BETA  = pinv([C B])*y;
	ResSS = sum((y - [C B]*BETA).^2);
    beta = BETA;
	
	%-Compute t-statistics for specified compounds of parameters
	%-----------------------------------------------------------
	Co     = [1 0];
	  % t, as usual
	  T = Co*BETA./sqrt((ResSS*(Co*pinv([C B]'*[C B])*Co'))/df);
          
  T0 = T;
  nPtmp = 1;
   % Save everything
   stats.ols_s = ols_s;
   stats.robust_s = robust_s;
   stats.mad_s = mad_s;
   stats.s = sigma;
   stats.resid = r;
   stats.rstud = r .* adjfactor / sigma;
   stats.se = se;
   stats.covb = covb;
   stats.coeffcorr = C;
   stats.t = repmat(NaN,size(b));
   stats.t(se>0) = b(se>0) ./ se(se>0);
   stats.p = 2 * tcdf(-abs(stats.t), dfe);
   stats.w = w;


%=======================================================================
% - C O M P U T E   F O R   P E R M U T A T I O N S
%=======================================================================

	%-Loop over permutations
	%-----------------------------------------------------------------
	for perm = 2:nPerm
	    
	    %-Rebuild H C for current permuation
	    %-----------------------------------------------------------
	    HC = PiCond(perm,:) - mean(x);
        HC = HC(:);
	    
	    %-Estimate parameters and sum of squares due to error
	    %-Use pseudo inverse rather than BETA=inv(D'*D)*D'*X
	    % for D = DesMtx, to allow for non-unique designs. 
	    % See matlab help.
	    %-----------------------------------------------------------
	    BETA  = pinv([HC B])*y;
	    ResSS = sum((y - [HC B]*BETA).^2);
	    	    
	    %-Compute t-statistics for specified contrast of parameters
	    %-----------------------------------------------------------
	    Co     = [1 0];
	      % t, as usual
	      T = Co*BETA./sqrt((ResSS*(Co*pinv([HC B]'*[HC B])*Co'))/df);
	    	   
	    
	    %-Update nonparametric P-value
	    %-----------------------------------------------------------
	    if (perm==1)
	      T0 = T;
	      nPtmp = 1;
        else
          nPtmp = nPtmp + (T>=T0);
        end

	end 	% (for perm = StartPerm:nPerm) - Perm loop
    pval = nPtmp/nPiCond;
 

end

